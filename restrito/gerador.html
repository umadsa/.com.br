<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Credencial Premium | UMADSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #222; color: #fff; }
        #printArea { width: 450px; background: white; padding: 20px; display: flex; flex-direction: column; gap: 4px; margin: auto; }
        .card { width: 400px; height: 250px; background: #000; border-radius: 12px; position: relative; overflow: hidden; color: white; border: 1px solid #333; }
        .gold-bar { background: #D4AF37; height: 100%; width: 40px; position: absolute; right: 0; top: 0; display: flex; align-items: center; justify-content: center; }
        .priority-text { transform: rotate(90deg); color: #000; font-weight: 800; font-size: 11px; letter-spacing: 2px; white-space: nowrap; }
        .logo-main { width: 50px; position: absolute; top: 20px; right: 60px; }
        .photo-box { width: 95px; height: 120px; border: 2px solid #D4AF37; position: absolute; left: 20px; top: 50px; border-radius: 8px; overflow: hidden; background: #111; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }
        .info-container { position: absolute; left: 130px; top: 50px; right: 50px; text-align: left; }
        
        /* FIX: Quebra de linha para nomes longos como Alessandro */
        .name-text { 
            font-size: 18px; font-weight: 800; line-height: 1.1; text-transform: uppercase; color: #D4AF37;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            margin-bottom: 4px;
        }
        
        .cargo-text { font-size: 11px; font-weight: 400; color: #aaa; text-transform: uppercase; }
        .id-text { font-family: 'Courier New', monospace; font-size: 15px; color: #D4AF37; position: absolute; bottom: 25px; left: 130px; letter-spacing: 2px; }
        .magnetic-stripe { background: #D4AF37; height: 35px; width: 100%; margin-top: 25px; }
    </style>
</head>
<body class="p-8">
    <div class="text-center">
        <div id="status" class="mb-4 text-yellow-500 font-bold">Carregando dados ministerial...</div>
        
        <div id="printArea" class="shadow-2xl opacity-0">
            <div class="card" id="cardFrente">
                <div class="p-4 text-left italic text-[12px] text-gray-400">Ministerial Card</div>
                <div class="logo-main"><img src="https://umadsa.github.io/.com.br/assets/logotipos/BRASAO_UMADSA_ORG.png"></div>
                <div class="photo-box"><img id="fFoto" src=""></div>
                <div class="info-container">
                    <div class="name-text" id="fNome">---</div>
                    <div class="cargo-text" id="fCargo">---</div>
                </div>
                <div class="id-text" id="fID">0000 0000 0000 0000</div>
                <div class="gold-bar"><div class="priority-text">#UMADSA 2026™</div></div>
            </div>

            <div class="card">
                <div class="magnetic-stripe"></div>
                <div class="p-4 text-left text-[9px] leading-tight text-gray-300">
                    ESTE CARTÃO É DE USO PESSOAL E INTRANSFERÍVEL.<br>
                    PROPRIEDADE DA UNIÃO DE MOCIDADE DA ASSEMBLEIA DE DEUS EM SANTO AMARO.
                </div>
                <div class="flex px-4 justify-between items-end mt-4">
                    <div class="text-left text-[10px]">
                        <span class="text-yellow-500 font-bold">NASCIMENTO:</span> <span id="vNasc">--/--/----</span><br>
                        <span class="text-yellow-500 font-bold">CONGREGAÇÃO:</span> <span id="vCong">---</span>
                    </div>
                    <div class="text-right">
                        <div class="border-t border-white w-32 text-[7px] text-center pt-1 uppercase">Pr. Marcio Dias - Presidente UMADSA</div>
                    </div>
                </div>
                <div class="mt-6 flex justify-center">
                    <div class="bg-white px-2 py-1 text-black font-mono text-[9px] tracking-tighter">@umadsaoficial | umadsa.github.io</div>
                </div>
            </div>
        </div>

        <button id="btnPdf" onclick="gerarPDF()" class="mt-8 bg-yellow-500 text-black px-10 py-4 rounded-full font-bold hidden">BAIXAR CARTEIRINHA</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwj7piuiqToBuYjzKob73dEjFeUZ23Ny7zGh_glOxpTdCkHWsvMD9NgWBb296-K-JUZ/exec";
        
       async function carregar() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            
            if (!id) {
                document.getElementById('status').innerText = "Erro: Link inválido (ID ausente).";
                return;
            }

            try {
                const response = await fetch(`${API_URL}?action=buscarLider&idLider=${id}&authToken=umadsa2026tokendeseguranca`);
                const result = await response.json();

                if (result.status === 'success') {
                    const data = result.data;
                    
                    document.getElementById('fNome').innerText = data.nome;
                    document.getElementById('fCargo').innerText = data.cargo;
                    document.getElementById('vCong').innerText = data.congregacao;
                    
                    // FIX: Formata a data no Front-end também, caso o fuso horário do Sheets envie ISO
                    let nascExibir = data.nascimento;
                    if (nascExibir && nascExibir.includes('T')) {
                        const d = new Date(nascExibir);
                        // Força a data local sem distorção de fuso
                        nascExibir = d.getUTCDate().toString().padStart(2, '0') + '/' + 
                                     (d.getUTCMonth() + 1).toString().padStart(2, '0') + '/' + 
                                     d.getUTCFullYear();
                    }
                    document.getElementById('vNasc').innerText = nascExibir;
                    
                    const idLivre = data.id.replace("LID-", "");
                    document.getElementById('fID').innerText = idLivre.replace(/(\d{4})/g, '$1 ').trim();
                    
                    const img = document.getElementById('fFoto');
                    img.crossOrigin = "anonymous";
                    
                    const timeoutFoto = setTimeout(() => { finalizarCarregamento(); }, 2500);

                    img.onload = () => {
                        clearTimeout(timeoutFoto);
                        finalizarCarregamento();
                    };

                    img.onerror = () => {
                        img.src = "https://umadsa.github.io/.com.br/assets/logotipos/BRASAO_UMADSA_ORG.png";
                        finalizarCarregamento();
                    };

                    img.src = data.urlFoto;

                } else {
                    document.getElementById('status').innerText = "Líder não encontrado.";
                }
            } catch (err) {
                document.getElementById('status').innerText = "Falha de conexão com o servidor.";
                console.error(err);
            }
        }

        // Função auxiliar para mostrar o card na tela
        function finalizarCarregamento() {
            document.getElementById('status').classList.add('hidden');
            const printArea = document.getElementById('printArea');
            printArea.classList.remove('opacity-0');
            printArea.style.opacity = "1";
            document.getElementById('btnPdf').classList.remove('hidden');
        }
        function gerarPDF() {
            const element = document.getElementById('printArea');
            const btn = document.getElementById('btnPdf');
            btn.innerText = "PROCESSANDO...";
            
            const opt = {
                margin: 10,
                filename: 'Carteirinha_UMADSA_2026.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerText = "BAIXAR CARTEIRINHA";
            });
        }
        
        window.onload = carregar;
    </script>
</body>
</html>
